name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-macos-universal:
    runs-on: macos-14  # Use macos-14 for stable Xcode/SDK compatibility

    defaults:
      run:
        working-directory: nactl-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: |
        xcodebuild -version
        swift --version

    - name: Build Release (Universal Binary - arm64 + x86_64)
      run: swift build -c release -v --arch arm64 --arch x86_64

    - name: Verify universal binary
      run: |
        echo "Binary info:"
        file .build/apple/Products/Release/nactl
        lipo -info .build/apple/Products/Release/nactl
        echo ""
        echo "Architectures:"
        lipo -archs .build/apple/Products/Release/nactl

    - name: Create distribution archive
      run: |
        mkdir -p dist
        cp .build/apple/Products/Release/nactl dist/
        cp README.md dist/
        cd dist
        zip -r ../nactl-macos-universal.zip .
        cd ..
        tar -czvf nactl-macos-universal.tar.gz -C dist .

    - name: Upload macOS Universal artifact
      uses: actions/upload-artifact@v4
      with:
        name: nactl-macos-universal
        path: |
          nactl-macos/nactl-macos-universal.zip
          nactl-macos/nactl-macos-universal.tar.gz
        retention-days: 90

  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: nactl-windows

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build Release
      run: cargo build --release -v

    - name: Create distribution archive
      run: |
        New-Item -ItemType Directory -Force -Path dist
        Copy-Item target\release\nactl.exe dist\
        Copy-Item README.md dist\
        Compress-Archive -Path dist\* -DestinationPath nactl-windows-x64.zip
      shell: pwsh

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: nactl-windows-x64
        path: nactl-windows/nactl-windows-x64.zip
        retention-days: 90

  create-release:
    needs: [build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v7
      with:
        path: artifacts

    - name: Display downloaded artifacts
      run: ls -R artifacts

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: nactl ${{ steps.version.outputs.version }}
        draft: true
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/nactl-macos-universal/nactl-macos-universal.zip
          artifacts/nactl-macos-universal/nactl-macos-universal.tar.gz
          artifacts/nactl-windows-x64/nactl-windows-x64.zip
        body: |
          ## nactl ${{ steps.version.outputs.version }}

          Network Admin Control CLI tool for FoFo Lifeline.

          ### Downloads

          | Platform | Architecture | File |
          |----------|--------------|------|
          | macOS | Universal (Intel + Apple Silicon) | `nactl-macos-universal.zip` |
          | Windows | x64 | `nactl-windows-x64.zip` |

          ### Installation

          **macOS:**
          ```bash
          unzip nactl-macos-universal.zip
          sudo cp nactl /usr/local/bin/
          ```

          **Windows:**
          Extract `nactl-windows-x64.zip` and add to PATH or copy to `C:\Windows\System32\`

          ### What's New

          See the auto-generated release notes below for changes.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
