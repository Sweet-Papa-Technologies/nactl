name: macOS CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'nactl-macos/**'
      - '.github/workflows/macos-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'nactl-macos/**'
      - '.github/workflows/macos-ci.yml'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: macos-latest

    defaults:
      run:
        working-directory: nactl-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v3
      with:
        swift-version: '5.9'

    - name: Show Swift version
      run: swift --version

    - name: Resolve dependencies
      run: swift package resolve

    - name: Build (Debug)
      run: swift build -v

    - name: Build (Release)
      run: swift build -c release -v

    - name: Make test script executable
      run: chmod +x test_nactl.sh

    - name: Run tests
      run: |
        # Run safe tests only (skip wifi scan which needs Location Services)
        ./test_nactl.sh 2>&1 || true
      continue-on-error: true  # Some tests may fail in CI (Location Services, network)

    - name: Verify binary exists
      run: |
        ls -la .build/debug/nactl
        ls -la .build/release/nactl

    - name: Test help command
      run: .build/debug/nactl --help

    - name: Test version command
      run: .build/debug/nactl --version

    - name: Test status command (JSON)
      run: .build/debug/nactl status --json || true
      continue-on-error: true  # May fail if no network interface

    - name: Test ping localhost
      run: .build/debug/nactl ping 127.0.0.1 --count 2 --json

    - name: Upload debug binary
      uses: actions/upload-artifact@v4
      with:
        name: nactl-macos-debug
        path: nactl-macos/.build/debug/nactl
        retention-days: 7

    - name: Upload release binary
      uses: actions/upload-artifact@v4
      with:
        name: nactl-macos-release
        path: nactl-macos/.build/release/nactl
        retention-days: 30

  lint:
    runs-on: macos-latest

    defaults:
      run:
        working-directory: nactl-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v3
      with:
        swift-version: '5.9'

    - name: Check Swift formatting (if swiftformat available)
      run: |
        if command -v swiftformat &> /dev/null; then
          swiftformat --lint Sources/
        else
          echo "swiftformat not installed, skipping lint"
        fi
      continue-on-error: true
