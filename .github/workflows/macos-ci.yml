name: macOS CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'nactl-macos/**'
      - '.github/workflows/macos-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'nactl-macos/**'
      - '.github/workflows/macos-ci.yml'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: macos-14  # Use macos-14 for stable Xcode/SDK compatibility

    defaults:
      run:
        working-directory: nactl-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: |
        xcodebuild -version
        swift --version
        echo "Available SDKs:"
        xcodebuild -showsdks

    - name: Resolve dependencies
      run: swift package resolve

    - name: Build Debug (Universal Binary)
      run: swift build -v --arch arm64 --arch x86_64

    - name: Build Release (Universal Binary)
      run: swift build -c release -v --arch arm64 --arch x86_64

    - name: Verify universal binary
      run: |
        echo "=== Debug Binary ==="
        file .build/apple/Products/Debug/nactl
        lipo -info .build/apple/Products/Debug/nactl
        echo ""
        echo "=== Release Binary ==="
        file .build/apple/Products/Release/nactl
        lipo -info .build/apple/Products/Release/nactl

    - name: Make test script executable
      run: chmod +x test_nactl.sh

    - name: Run safe tests
      run: |
        export NACTL_PATH=".build/apple/Products/Debug/nactl"
        ./test_nactl.sh 2>&1 || true
      continue-on-error: true  # Some tests may fail in CI (Location Services, network)

    - name: Test help command
      run: .build/apple/Products/Debug/nactl --help

    - name: Test version command
      run: .build/apple/Products/Debug/nactl --version

    - name: Test status command (JSON)
      run: .build/apple/Products/Debug/nactl status --json || true
      continue-on-error: true  # May fail if no network interface

    - name: Test ping localhost
      run: .build/apple/Products/Debug/nactl ping 127.0.0.1 --count 2 --json

    - name: Upload debug binary (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: nactl-macos-debug-universal
        path: nactl-macos/.build/apple/Products/Debug/nactl
        retention-days: 7

    - name: Upload release binary (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: nactl-macos-release-universal
        path: nactl-macos/.build/apple/Products/Release/nactl
        retention-days: 30

  lint:
    runs-on: macos-14

    defaults:
      run:
        working-directory: nactl-macos

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Swift formatting (if swiftformat available)
      run: |
        if command -v swiftformat &> /dev/null; then
          swiftformat --lint Sources/
        else
          echo "swiftformat not installed, skipping lint"
        fi
      continue-on-error: true
